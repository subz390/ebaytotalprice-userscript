// ==UserScript==
// @name         ebaytotalprice-userscript
// @namespace    https://github.com/subz390
// @version      2.3.3.230215200537
// @description  Add the total eBay auction price including postage in the auction listing
// @author       SubZ390
// @license      MIT
// @run-at       document-idle
// @grant        none
// @noframes
// @include      /^https?://(ar|b[ory]|c[lor]|do|ec|gt|hn|il|kz|mx|ni|p[aerty]|ru|sv|uy|ve|www)\.ebay\.com/
// @include      /^https?://www\.ebay\.com\.au/
// @include      /^https?://www\.ebay\.co\.uk/
// @include      /^https?://www\.ebay\.(at|ca|de|es|fr|ie|it|nl|ph|pl)/
// @include      /^https?://www\.be(nl|fr)\.ebay\.be/
//
//
// ==/UserScript==

function e(e,t=!0){if("object"!=typeof e)return typeof e;if(null===e)return"null";if(Array.isArray(e))return"array";const n=Object.prototype.toString.call(e).slice(8,-1);return!0===t?n.toLowerCase():n}function t(t="",n,l=document){try{l=null===l?document:l;const n=e(t);if("string"==n){if(""==t)return null;let n=e(l);if("text"==n)return null;if("string"==n){const e=document.querySelector(l);if(null==e)return null;l=e}return n=e(l),-1!==n.search(/array|nodelist|svgsvgelement|html|document/i)?l.querySelector(t):null}return-1!==n.search(/array|nodelist|svgsvgelement|html/i)?t:(n.search(/null/),null)}catch(e){console.error(e)}}function n(e,t,n=1){if(null===e)return null;const l=e.match(t);return l?"all"==n?l:l[n]?l[n]:l[0]:null}function l({t:e="",l:t=/{([^{}]+)}/g,values:n}={}){if(""===e)return console.warn("template is an empty string"),null;function l(e,n){return e.replace(t,((e,t)=>n[t]?"function"==typeof n[t]?n[t]().toString():n[t]||e:0===n[t]?n[t].toString():"string"==typeof n[t]&&0==n[t].length?"":e))}return Array.isArray(n)?(n.forEach((t=>{e=l(e,t)})),e):l(e,n)}function r({selector:e=null,scope:n=document,i:l=!1,all:r=!1,contains:i=null,o=!1,u:c=""}={}){const s={m:{p:`${c}selector is undefined`,S:`${c}scope is not useable`}};if("language"===o)return s;try{if(null===e)return console.error(s.m.p),null;if(n!==document&&null===(n=t(n)))return null;if("scope"===o)return n;if("options"===o)return{selector:e,scope:n,i:l,all:r,contains:i,o};if(!0===r){const t=n.querySelectorAll(e);if(0===t.length)return null;if(!0===l){if(null!==i){const e=[];return t.forEach((t=>{-1!==t.textContent.search(i)&&e.push(t)})),0===e.length?null:e}return Array.from(t)}if(null!==i){for(let e=0;e<t.length;e++)if(-1!==t[e].textContent.search(i))return t;return null}return t}{const t=n.querySelector(e);return null===t||("string"==typeof i||i instanceof RegExp)&&-1===t.textContent.search(i)?null:!0===l?[t]:t}}catch(e){console.error(e)}}const i=/((\d+[,\.])+\d+)/,o=/(\$|EUR|PHP|zł|£)/;function c(e){try{let t=n(e.textContent.trim(),i);return t=t.replace(/[,\.]/g,""),t=parseFloat(t),t}catch(e){return console.error(e),null}}function s({g:e,h:t,v:i=null,P:s,I:a=null}){const u=r({selector:e,all:!0,i:!0});if(u)for(let e=0;u[e];e++){const m=r({selector:t,scope:u[e]}),p=r({selector:s,scope:u[e],contains:/\d/});if(m&&p){const e=n(m.textContent.trim(),o),t=n(p.textContent.trim(),o);if(t&&t===e){const e=((c(m)+c(p))/100).toFixed(2),n=l({t:a||i,values:{itemPrice:m.textContent.trim(),itemShippingAmount:p.textContent.trim(),currencySymbol:t,totalPrice:e}});i?m.insertAdjacentHTML("afterend",n):p.innerHTML=n}}}}(({style:e,className:n,T:l="afterend",_:r="body",C:i=5,A:o})=>{new Promise(((c,s)=>{const a=document.createElement("style");a.appendChild(document.createTextNode(e)),n&&(a.className=n),(({C:e=3,every:t=100,test:n=(()=>!1),j:l=(()=>null),timeout:r=(()=>null)}={})=>{if(!1===(()=>{const e=n();return!!e&&(l(e),!0)})()){const i=setInterval((()=>{const e=n();e&&(clearInterval(i),clearTimeout(o),l(e))}),t),o=setTimeout((()=>{clearInterval(i),r()}),1e3*e)}})({C:i,every:100,test:()=>t(r),j(e){c(((e,t)=>void 0!==l?e.insertAdjacentElement(l,t):e.appendChild(t))(e,a))},timeout:()=>s(Error(o||`appendStyle timed out whilst waiting for targetNode: ${r}`))})}))})({style:".total-price{background:hsl(76,100%,50%)!important;color:hsl(0,0%,9%)!important;padding:1px 4px;margin-left:5px;font-size:20px!important;font-weight:400!important;}.s-item__detail{overflow:visible!important;}"}),(e=>{try{const n=(()=>{for(const[n,l]of Object.entries(e))for(let e=0;e<l.F.length;e++)if(null!==t(l.F[e]))return l;return null})();null!==n&&n.process()}catch(e){console.error(e)}})({search:{F:["#mainContent ul.srp-results","#mainContent ul.b-list__items_nofooter"],process:()=>s({g:"#mainContent li.s-item",h:".s-item__price",P:".s-item__shipping",v:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})},$:{F:["#mainContent ul#ListViewInner"],process:()=>s({g:"#mainContent li",h:".lvprice span",P:".lvshipping span.fee",v:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})},N:{F:['#mainContent form[name="viactiondetails"]'],process:()=>function({g:e,h:i,O:s,v:a=null,P:u,U:m,I:p=null}){const f=r({selector:e});if(f){const e=r({selector:s,scope:f,contains:/\d/})||r({selector:i,scope:f,contains:/\d/});let d=r({selector:m,scope:f,contains:/\d/})||r({selector:u,scope:f,contains:/\d/});if(null===d){const e=r({selector:"span",scope:f,contains:"Postage:",all:!0,i:!0});d=(({L:e,contains:t=null})=>{let n=e;for(let e=1;!1===n.isEqualNode(document);e++){if(-1!==n.textContent.search(t))return n;n=n.parentNode}return null})({L:e[0],contains:/\d/})}if(e&&d){const r=n(e.textContent.trim(),o),i=n(d.textContent.trim(),o);if(i&&i===r){const n=((c(e)+c(d))/100).toFixed(2),r=l({t:p||a,values:{itemPrice:e.textContent.trim(),itemShippingAmount:d.textContent.trim(),currencySymbol:i,totalPrice:n}});a?e.insertAdjacentHTML("afterend",r):d.innerHTML=r,new MutationObserver(((n,r)=>{n.forEach((n=>{n.addedNodes.forEach((n=>{if("#text"==n.nodeName){const n=t("span.total-price"),r=((c(e)+c(d))/100).toFixed(2),o=l({t:"{currencySymbol}{totalPrice}",values:{itemPrice:e.textContent.trim(),itemShippingAmount:d.textContent.trim(),currencySymbol:i,totalPrice:r}});n.textContent=o}}))}))})).observe(e,{childList:!0})}}}}({g:"#mainContent",h:'span[itemprop="price"]',O:"#prcIsumConv",P:'div[class*="shipping"]',U:"#convetedPriceId",v:'<span class="total-price">{currencySymbol}{totalPrice}</span>'})}});
